import logging
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters,
    ContextTypes
)

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

TOKEN = '8510780024:AAGsBRszZHr1ruw_l1Mje9g2wdkzfqRp9MM'  # Замените на свой токен

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # Главное меню
    keyboard = [
        ["Записаться на консультацию", "Расписание"],
        ["Информация о техникуме", "Помощь"],
        ["Связь с администрацией", "Оставить отзыв"]  # Добавлена кнопка "Оставить отзыв"
    ]

    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    await update.message.reply_text(
        "Добро пожаловать! Я - бот секретарь техникума. Выберите действие:",
        reply_markup=reply_markup
    )

async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if text == "Записаться на консультацию":
        # Инлайн-клавиатура для выбора специалиста
        keyboard = [
            [InlineKeyboardButton("Иванов В.И.", callback_data="consult_ivanov")],
            [InlineKeyboardButton("Петров И.П.", callback_data="consult_petrov")],
            [InlineKeyboardButton("Сидорова У.А.", callback_data="consult_sidorova")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("Выберите специалиста:", reply_markup=reply_markup)

    elif text == "Расписание":
        await update.message.reply_text("Расписание занятий:\n(КАНИКУЛЫЫЫЫ ЮХУУУУУУУУУ, НЕТУ У НАС ЗАНЯТИЙ БАКА ЧАН)")

    elif text == "Информация о техникуме":
        await update.message.reply_text("Информация о техникуме:\n(Техникум – центр общественной жизни не только Устиновского района. Здесь регулярно проходят общественно-массовые мероприятия для аудиторий разных возрастов, республиканские спортивные соревнования, методические объединения преподавателей Удмуртии. А в последние годы техникум является Региональным оператором Национального Чемпионата профессий и предпринимательских идей «Карьера в России», положившему начало развитию студенческого предпринимательства.)")

    elif text == "Связь с администрацией":
        keyboard = [[InlineKeyboardButton("Написать в приемную комиссию", url="https://t.me/@zembekov")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("Свяжитесь с администрацией:", reply_markup=reply_markup)

    elif text == "Помощь":
        await update.message.reply_text("Я могу помочь вам с записью на консультацию, предоставить расписание и информацию о техникуме.")

    elif text == "Оставить отзыв":  # Обработка кнопки "Оставить отзыв"
        await update.message.reply_text("Пожалуйста, напишите ваш отзыв:")
        context.user_data['waiting_for_feedback'] = True  # Устанавливаем флаг, что ждем отзыв

    else:
        if context.user_data.get('waiting_for_feedback'):
             await update.message.reply_text("Спасибо за ваш отзыв!")
             context.user_data['waiting_for_feedback'] = False  # Сбрасываем флаг
        else:
            await update.message.reply_text("Я не понимаю эту команду. Пожалуйста, используйте кнопки меню.")

async def handle_inline_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "consult_ivanov":
        await query.edit_message_text("Вы выбрали консультацию у Иванова И.И.\n(Короче сталкер, идешь на второй этаж и там будет сидоров, берешь у него бутылку водки и идешь в подвал сдавать экзамен у Иванова)")
    elif query.data == "consult_petrov":
        await query.edit_message_text("Вы выбрали консультацию у Петрова П.П.\n(Артем, ты меня слышишь? Мутанты уж слишком разбушевались в метро в последнии месяцы, короче идешь на станцию фашистов и там будет этот самый Петрович")
    elif query.data == "consult_sidorova":
        await query.edit_message_text("Вы выбрали консультацию у Сидоровой А.А.\n(Гордон, ты меня слышишь? Засунь руку в хэдкраба и достань пропуск до Сидоровой)")

def main():
    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(handle_inline_buttons))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_buttons))
    application.run_polling()

if __name__ == '__main__':
    main()
